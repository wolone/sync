name: ã€ç¨³å®šç‰ˆã€‘å®šæ—¶åŒæ­¥ Frappe ä»“åº“åˆ° CNBï¼ˆä¿ç•™è‡ªå®šä¹‰åˆ†æ”¯ï¼‰
on:
  schedule:
    - cron: '0 19 * * *'
  workflow_dispatch:
    inputs:
      sync_mode:
        description: 'åŒæ­¥æ¨¡å¼'
        required: true
        default: 'full'
        type: choice
        options:
          - full: å…¨é‡åŒæ­¥æ‰€æœ‰ä»“åº“
          - single: åŒæ­¥å•ä¸ªä»“åº“
      repo_name:
        description: 'å•ä¸ªä»“åº“åï¼ˆä»… sync_mode=single æ—¶ç”Ÿæ•ˆï¼‰'
        required: false
        type: string

jobs:
  sync-frappe-to-cnb:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: ğŸ”§ å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆGitã€jqã€curlã€é‡è¯•å·¥å…·ï¼‰
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            git jq curl ca-certificates
          curl -fsSL https://github.com/kadwanev/retry/releases/download/v0.11.0/retry-linux-amd64 -o /usr/local/bin/retry
          chmod +x /usr/local/bin/retry
          git --version
          jq --version
          curl --version
          retry --version

      - name: ğŸ“ åˆå§‹åŒ–åŒæ­¥æ—¥å¿—
        run: |
          echo "=== åŒæ­¥ä»»åŠ¡å¼€å§‹ ===" > sync_logs.txt
          echo "æ‰§è¡Œæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S UTC')" >> sync_logs.txt
          echo "åŒæ­¥æ¨¡å¼ï¼š${{ github.event.inputs.sync_mode }}" >> sync_logs.txt
          [ -n "${{ github.event.inputs.repo_name }}" ] && echo "æŒ‡å®šä»“åº“ï¼š${{ github.event.inputs.repo_name }}" >> sync_logs.txt
          echo "CNB ç”¨æˆ·åï¼šcnbï¼ˆå›ºå®šï¼‰" >> sync_logs.txt

      - name: ğŸ“¥ åŠ¨æ€è·å– Frappe å…¨é‡ä»“åº“åˆ—è¡¨ï¼ˆå…¨é‡æ¨¡å¼ï¼‰
        if: github.event.inputs.sync_mode == 'full'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "å¼€å§‹ä» GitHub API è·å– Frappe æ‰€æœ‰å…¬å¼€ä»“åº“..." >> sync_logs.txt
          PAGE=1
          ALL_REPOS=()
          while true; do
            RESPONSE=$(retry -n 3 -d 5 curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/orgs/frappe/repos?per_page=100&page=$PAGE&type=public")
            if echo "$RESPONSE" | jq -e . > /dev/null 2>&1; then
              REPOS=$(echo "$RESPONSE" | jq -r '.[] | select(.fork == false) | .name')
              if [ -z "$REPOS" ] || [ "$REPOS" == "null" ]; then
                echo "å·²è·å–æ‰€æœ‰ä»“åº“ï¼Œå…± ${#ALL_REPOS[@]} ä¸ª" >> sync_logs.txt
                break
              fi
              ALL_REPOS+=($REPOS)
              echo "ç¬¬ $PAGE é¡µï¼šè·å–åˆ° $(echo "$REPOS" | wc -w) ä¸ªä»“åº“" >> sync_logs.txt
              PAGE=$((PAGE + 1))
            else
              echo "âš ï¸ ç¬¬ $PAGE é¡µä»“åº“è·å–å¤±è´¥ï¼Œè·³è¿‡è¯¥é¡µ" >> sync_logs.txt
              PAGE=$((PAGE + 1))
              [ $PAGE -gt 10 ] && break
            fi
          done
          echo "REPOS_LIST=${ALL_REPOS[*]}" >> $GITHUB_ENV
          echo "æœ€ç»ˆå¾…åŒæ­¥ä»“åº“æ•°ï¼š${#ALL_REPOS[@]}" >> sync_logs.txt

      - name: ğŸ“Œ æŒ‡å®šå•ä¸ªåŒæ­¥ä»“åº“ï¼ˆå•ä¸ªæ¨¡å¼ï¼‰
        if: github.event.inputs.sync_mode == 'single'
        run: |
          if [ -z "${{ github.event.inputs.repo_name }}" ]; then
            echo "âŒ å•ä¸ªæ¨¡å¼å¿…é¡»æŒ‡å®šä»“åº“å" >> sync_logs.txt
            exit 1
          fi
          GITHUB_REPO_URL="https://github.com/frappe/${{ github.event.inputs.repo_name }}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$GITHUB_REPO_URL")
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ ä»“åº“ ${{ github.event.inputs.repo_name }} ä¸å­˜åœ¨äº GitHub frappe ç»„ç»‡ï¼ˆHTTP çŠ¶æ€ç ï¼š$HTTP_CODEï¼‰" >> sync_logs.txt
            exit 1
          fi
          echo "REPOS_LIST=${{ github.event.inputs.repo_name }}" >> $GITHUB_ENV
          echo "å¾…åŒæ­¥ä»“åº“ï¼š${{ github.event.inputs.repo_name }}" >> sync_logs.txt

      - name: ğŸ” é…ç½® Git èº«ä»½
        run: |
          git config --global user.name "CNB-Sync-Bot"
          git config --global user.email "sync-bot@cnb.cool"
          git config --global pull.rebase false
          echo "Git èº«ä»½é…ç½®å®Œæˆ" >> sync_logs.txt

      - name: âœ… æ ¡éªŒ CNB è®¿é—®æƒé™ï¼ˆç”¨æˆ·åï¼šcnbï¼‰
        env:
          CNB_TOKEN: ${{ secrets.CNB_TOKEN }}
          CNB_USERNAME: "cnb"
          CNB_API_URL: "https://api.cnb.cool"
        run: |
          echo "å¼€å§‹æ ¡éªŒ CNB æƒé™ï¼ˆç”¨æˆ·åï¼š$CNB_USERNAMEï¼‰..." >> sync_logs.txt
          RESPONSE=$(retry -n 2 -d 3 curl -s -H "Authorization: token $CNB_TOKEN" "$CNB_API_URL/user")
          if echo "$RESPONSE" | jq -e '.username' > /dev/null 2>&1; then
            CNB_ACTUAL_USER=$(echo "$RESPONSE" | jq -r '.username')
            if [ "$CNB_ACTUAL_USER" == "$CNB_USERNAME" ]; then
              echo "âœ… CNB æƒé™æ ¡éªŒé€šè¿‡ï¼ˆç”¨æˆ·åï¼š$CNB_USERNAMEï¼‰" >> sync_logs.txt
            else
              echo "âŒ CNB ä»¤ç‰Œå¯¹åº”çš„ç”¨æˆ·åä¸åŒ¹é…ï¼ˆå®é™…ï¼š$CNB_ACTUAL_USERï¼Œè¦æ±‚ï¼š$CNB_USERNAMEï¼‰" >> sync_logs.txt
              exit 1
            fi
          else
            echo "âŒ CNB ä»¤ç‰Œæ— æ•ˆæˆ– API è°ƒç”¨å¤±è´¥ï¼ˆå“åº”ï¼š$RESPONSEï¼‰" >> sync_logs.txt
            exit 1
          fi

      - name: ğŸš€ å¾ªç¯åŒæ­¥ä»“åº“åˆ° CNBï¼ˆç”¨æˆ·åï¼šcnbï¼‰
        env:
          CNB_TOKEN: ${{ secrets.CNB_TOKEN }}
          CNB_USERNAME: "cnb"
          CNB_API_URL: "https://api.cnb.cool"
        run: |
          FAIL_FLAG=0
          for REPO_NAME in $REPOS_LIST; do
            echo -e "\n=== å¼€å§‹åŒæ­¥ä»“åº“ï¼š$REPO_NAME ===" >> sync_logs.txt
            GITHUB_REPO="https://github.com/frappe/$REPO_NAME.git"
            CNB_REPO="https://$CNB_USERNAME:$CNB_TOKEN@api.cnb.cool/$CNB_USERNAME/$REPO_NAME.git"
            TEMP_REPO_DIR="temp_$REPO_NAME"

            echo "1. æ£€æŸ¥ CNB ä»“åº“æ˜¯å¦å­˜åœ¨..." >> sync_logs.txt
            CNB_REPO_CHECK_URL="$CNB_API_URL/repos/$CNB_USERNAME/$REPO_NAME"
            HTTP_CODE=$(retry -n 2 -d 3 curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token $CNB_TOKEN" "$CNB_REPO_CHECK_URL")
            
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "âœ… CNB ä»“åº“å·²å­˜åœ¨ï¼š$CNB_USERNAME/$REPO_NAME" >> sync_logs.txt
            elif [ "$HTTP_CODE" -eq 404 ]; then
              echo "âš ï¸ CNB ä»“åº“ä¸å­˜åœ¨ï¼Œå¼€å§‹åˆ›å»ºï¼š$CNB_USERNAME/$REPO_NAME" >> sync_logs.txt
              CREATE_RESPONSE=$(retry -n 2 -d 5 curl -s -X POST \
                -H "Authorization: token $CNB_TOKEN" \
                -H "Content-Type: application/json" \
                -d '{
                  "name": "'"$REPO_NAME"'",
                  "private": false,
                  "description": "ğŸ”„ è‡ªåŠ¨åŒæ­¥è‡ª GitHub frappe/'$REPO_NAME'ï¼ˆä¿ç•™è‡ªå®šä¹‰åˆ†æ”¯ï¼‰",
                  "auto_init": false,
                  "gitignore_template": "Python"
                }' \
                "$CNB_API_URL/user/repos")
              if echo "$CREATE_RESPONSE" | jq -e '.name' > /dev/null 2>&1; then
                echo "âœ… CNB ä»“åº“åˆ›å»ºæˆåŠŸï¼š$CNB_USERNAME/$REPO_NAME" >> sync_logs.txt
              else
                echo "âŒ CNB ä»“åº“åˆ›å»ºå¤±è´¥ï¼ˆå“åº”ï¼š$CREATE_RESPONSEï¼‰" >> sync_logs.txt
                FAIL_FLAG=1
                continue
              fi
            else
              echo "âŒ ä»“åº“æ£€æŸ¥å¤±è´¥ï¼ˆHTTP çŠ¶æ€ç ï¼š$HTTP_CODEï¼‰" >> sync_logs.txt
              FAIL_FLAG=1
              continue
            fi

            echo "2. å…‹éš†ä»“åº“..." >> sync_logs.txt
            if git clone --depth 1 $CNB_REPO $TEMP_REPO_DIR; then
              echo "âœ… æˆåŠŸå…‹éš† CNB ä»“åº“ï¼ˆä¿ç•™è‡ªå®šä¹‰åˆ†æ”¯ï¼‰" >> sync_logs.txt
              cd $TEMP_REPO_DIR
              git remote add upstream $GITHUB_REPO 2>/dev/null || git remote set-url upstream $GITHUB_REPO
            else
              echo "âš ï¸ CNB ä»“åº“å…‹éš†å¤±è´¥ï¼Œå°è¯•ç›´æ¥å…‹éš† GitHub æºä»“åº“" >> sync_logs.txt
              if git clone $GITHUB_REPO $TEMP_REPO_DIR; then
                echo "âœ… æˆåŠŸå…‹éš† GitHub æºä»“åº“" >> sync_logs.txt
                cd $TEMP_REPO_DIR
                git remote set-url origin $CNB_REPO
              else
                echo "âŒ ä»“åº“å…‹éš†å¤±è´¥ï¼Œè·³è¿‡è¯¥ä»“åº“" >> sync_logs.txt
                FAIL_FLAG=1
                rm -rf $TEMP_REPO_DIR
                continue
              fi
            fi

            echo "3. åŒæ­¥ GitHub åˆ†æ”¯å’Œæ ‡ç­¾..." >> sync_logs.txt
            if retry -n 3 -d 5 git fetch upstream --all --tags; then
              echo "âœ… æˆåŠŸæ‹‰å– GitHub æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾" >> sync_logs.txt
            else
              echo "âŒ æ‹‰å– GitHub åˆ†æ”¯å¤±è´¥ï¼Œè·³è¿‡è¯¥ä»“åº“" >> sync_logs.txt
              FAIL_FLAG=1
              cd .. && rm -rf $TEMP_REPO_DIR
              continue
            fi

            for BRANCH in $(git branch -r | grep upstream/ | sed 's/upstream\///' | grep -v HEAD); do
              echo "  - å¤„ç†åˆ†æ”¯ï¼š$BRANCH" >> sync_logs.txt
              if git checkout -B $BRANCH upstream/$BRANCH 2>/dev/null; then
                echo "    âœ… åˆ†æ”¯ $BRANCH ä¸å­˜åœ¨ï¼Œåˆ›å»ºå¹¶åŒæ­¥" >> sync_logs.txt
              else
                git checkout $BRANCH
                if git merge upstream/$BRANCH --no-edit; then
                  echo "    âœ… åˆ†æ”¯ $BRANCH åˆå¹¶æ›´æ–°æˆåŠŸ" >> sync_logs.txt
                else
                  echo "    âš ï¸ åˆ†æ”¯ $BRANCH åˆå¹¶å†²çªï¼Œå°è¯•æ”¾å¼ƒæœ¬åœ°ä¿®æ”¹å¹¶åŒæ­¥" >> sync_logs.txt
                  git merge --abort 2>/dev/null
                  git reset --hard upstream/$BRANCH
                  echo "    âœ… å·²å¼ºåˆ¶åŒæ­¥ä¸Šæ¸¸åˆ†æ”¯ $BRANCH" >> sync_logs.txt
                fi
              fi
            done

            git push origin --tags 2>/dev/null && echo "âœ… æ ‡ç­¾åŒæ­¥å®Œæˆ" >> sync_logs.txt || echo "âš ï¸ æ ‡ç­¾åŒæ­¥æ— å˜æ›´" >> sync_logs.txt

            echo "4. æ¨é€ç»“æœåˆ° CNB..." >> sync_logs.txt
            if git push origin --all; then
              echo "âœ… ä»“åº“ $REPO_NAME åŒæ­¥å®Œæˆ" >> sync_logs.txt
            else
              echo "âŒ ä»“åº“ $REPO_NAME æ¨é€å¤±è´¥" >> sync_logs.txt
              FAIL_FLAG=1
            fi

            cd .. && rm -rf $TEMP_REPO_DIR
            echo "5. ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ" >> sync_logs.txt
          done
          # å°†å¤±è´¥æ ‡è®°å†™å…¥ç¯å¢ƒå˜é‡
          echo "FAIL_FLAG=$FAIL_FLAG" >> $GITHUB_ENV

      - name: ğŸ“Š åŒæ­¥ç»“æœæ±‡æ€»
        run: |
          echo -e "\n=== åŒæ­¥ä»»åŠ¡ç»“æŸ ===" >> sync_logs.txt
          echo "æ‰§è¡Œæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S UTC')" >> sync_logs.txt
          SUCCESS_COUNT=$(grep -c "âœ… ä»“åº“ .* åŒæ­¥å®Œæˆ" sync_logs.txt)
          FAIL_COUNT=$(grep -c "âŒ ä»“åº“ .* åŒæ­¥å¤±è´¥" sync_logs.txt)
          SKIP_COUNT=$(grep -c "è·³è¿‡è¯¥ä»“åº“" sync_logs.txt)
          echo "æ±‡æ€»ç»Ÿè®¡ï¼š" >> sync_logs.txt
          echo "  - å¾…åŒæ­¥ä»“åº“æ•°ï¼š${#REPOS_LIST[@]}" >> sync_logs.txt
          echo "  - åŒæ­¥æˆåŠŸï¼š$SUCCESS_COUNT ä¸ª" >> sync_logs.txt
          echo "  - åŒæ­¥å¤±è´¥ï¼š$FAIL_COUNT ä¸ª" >> sync_logs.txt
          echo "  - è·³è¿‡ä»“åº“ï¼š$SKIP_COUNT ä¸ª" >> sync_logs.txt
          cat sync_logs.txt

      - name: ğŸš¨ åŒæ­¥å¤±è´¥é€šçŸ¥ï¼ˆé€šè¿‡ GitHub Issuesï¼‰
        if: failure() || env.FAIL_FLAG == '1'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          ISSUE_TITLE="ã€ä»“åº“åŒæ­¥å¤±è´¥ã€‘$(date '+%Y-%m-%d')"
          ISSUE_BODY=$(cat <<EOF
          ### åŒæ­¥ä»»åŠ¡å¤±è´¥æ±‡æ€»
          - æ‰§è¡Œæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S UTC')
          - åŒæ­¥æ¨¡å¼ï¼š${{ github.event.inputs.sync_mode }}
          - CNB ç”¨æˆ·åï¼šcnb
          - å¤±è´¥ä»“åº“æ•°ï¼š$(grep -c "âŒ ä»“åº“ .* åŒæ­¥å¤±è´¥" sync_logs.txt)
          
          ### è¯¦ç»†æ—¥å¿—ï¼ˆæœ€å200è¡Œï¼‰
          \`\`\`
          $(cat sync_logs.txt | tail -200)
          \`\`\`
          EOF
          )
          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"title":"'"$ISSUE_TITLE"'", "body":"'"$ISSUE_BODY"'"}' \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues"
          echo "âœ… å¤±è´¥é€šçŸ¥å·²å‘é€åˆ° GitHub Issues"
