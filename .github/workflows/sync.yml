name: Sync Frappe Repository

on:
  schedule:
    - cron: "0 0 * * *"  # 每天凌晨同步一次
  workflow_dispatch:  # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v6
        with:
          repository: frappe/frappe
          fetch-depth: 0  # 获取完整历史
          path: source

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Sync to target repository
        run: |
          cd source
          # 添加目标仓库作为远程
          git remote add target https://x-access-token:${{ secrets.CNB_TOKEN }}@cnb.cool/frappecn/frappe.git
          # 拉取目标仓库最新信息（防止冲突）
          git fetch target
          # 推送所有分支和标签到目标仓库
          git push target --all --force
          git push target --tags --force
        env:
          # 需要在GitHub仓库设置中添加TARGET_REPO_TOKEN密钥，值为目标仓库的访问令牌
          CNB_TOKEN: ${{ secrets.CNB_TOKEN }}